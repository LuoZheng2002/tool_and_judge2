# Tool Format Comparison Tests

This directory contains unit tests to compare the tool formats generated by the Rust and Python implementations of the `generate_tool_call_async` function.

## Files

### Test Files
- **`tests/test_tool_format_comparison.rs`** - Rust unit test that generates tool formats
- **`test_tool_format_comparison.py`** - Python standalone test that generates tool formats
- **`compare_tool_formats.py`** - Comparison script to analyze differences

### Output Files
- **`tool_format_comparison_rust.json`** - Tool formats generated by Rust implementation
- **`tool_format_comparison_python.json`** - Tool formats generated by Python implementation

## Running the Tests

### Run Rust Test
```bash
cargo test test_rust_tool_format_generation --test test_tool_format_comparison -- --nocapture
```

### Run Python Test
```bash
python test_tool_format_comparison.py
```

### Compare Results
```bash
.venv/bin/python compare_tool_formats.py
```

## Test Results

The comparison script validates that both implementations generate **identical** tool formats when given the same BFCL dataset (`tool/dataset/BFCL_v4_multiple.jsonl`).

### Sample Output

Both implementations generate tools in the GPT-5 format:

```json
{
  "type": "function",
  "name": "triangle_properties_get",
  "description": "Retrieve the dimensions, such as area and perimeter, of a triangle if lengths of three sides are given.",
  "parameters": {
    "type": "object",
    "properties": {
      "side1": {
        "type": "integer",
        "description": "The length of first side of the triangle."
      },
      "side2": {
        "type": "integer",
        "description": "The length of second side of the triangle."
      },
      "side3": {
        "type": "integer",
        "description": "The length of third side of the triangle."
      },
      "get_area": {
        "type": "boolean",
        "description": "A flag to determine whether to calculate the area of triangle. Default is true."
      },
      "get_perimeter": {
        "type": "boolean",
        "description": "A flag to determine whether to calculate the perimeter of triangle. Default is true."
      },
      "get_angles": {
        "type": "boolean",
        "description": "A flag to determine whether to calculate the internal angles of triangle. Default is true."
      }
    },
    "required": [
      "side1",
      "side2",
      "side3"
    ]
  }
}
```

## What the Tests Validate

1. **Function Name Sanitization**: Both implementations correctly sanitize function names (e.g., `triangle_properties.get` → `triangle_properties_get`)
2. **Type Mapping**: Both correctly map BFCL types to GPT-5 types:
   - `dict` → `object`
   - `float` → `number`
   - `tuple` → `array`
3. **Parameter Handling**: Properties, descriptions, required fields, and nested items are all handled identically
4. **Name Mapping**: Both maintain correct bidirectional mappings between original and sanitized names

## Performance Note

If you suspect performance differences between the Rust and Python implementations, the issue is likely **not** in the tool format generation itself (as proven by these tests showing identical outputs). The performance difference may be in:

1. The actual API calls to GPT-5
2. Serialization/deserialization overhead
3. Python-Rust FFI boundary crossings
4. Async runtime differences

## Dataset

The tests use **BFCL v4 Multiple** dataset:
- **Path**: `tool/dataset/BFCL_v4_multiple.jsonl`
- **Entries**: 200 test cases
- **Format**: JSONL with function definitions and questions

Each test case contains:
- Multiple function definitions with various parameter types
- Complex nested structures (objects, arrays, etc.)
- Optional and required parameters
- Different type combinations
